<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
<!-- 2019-11-11 Mon 23:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bases de données relationnelles et Java</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Bases de données relationnelles et Java</h1>
<div id="table-of-contents">
<h2>Table des matières</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1abfe0d">1. Types de clients</a>
<ul>
<li><a href="#orgfcece04">1.1. Clients SQL génériques</a></li>
<li><a href="#org121b071">1.2. Clients spécifiques à une base de données</a></li>
</ul>
</li>
<li><a href="#org384b6e2">2. Requêtes SQL</a>
<ul>
<li><a href="#orgce9a4db">2.1. Sources de données</a></li>
<li><a href="#orgf0ff4af">2.2. Expressions</a></li>
<li><a href="#org4a047f5">2.3. Tris : clause ORDER BY</a></li>
<li><a href="#org08a93e7">2.4. Limitation du nombre de résultats : clause LIMIT et OFFSET</a></li>
<li><a href="#org9a3512b">2.5. Sélection de lignes : clause WHERE</a></li>
</ul>
</li>
<li><a href="#org4cba525">3. Création de la table cities</a></li>
<li><a href="#org355b2dc">4. Destruction de table</a></li>
<li><a href="#org81b1ed3">5. Insertions dans la table cities</a></li>
<li><a href="#org320e343">6. Suppression</a></li>
<li><a href="#org742ed79">7. Modification dans la table cities</a></li>
<li><a href="#org5cc8a75">8. Notion de transaction</a></li>
<li><a href="#org95e7502">9. Utilisation de SGBDR en Java : préliminaires</a>
<ul>
<li><a href="#orga22d5d0">9.1. Chargement de drivers</a></li>
<li><a href="#orgdbb0b48">9.2. Établissement de la connection au SGBDR</a></li>
</ul>
</li>
<li><a href="#org635d3f3">10. Utilisation de SGBDR en Java : requêtes SQL</a>
<ul>
<li><a href="#org8160e5f">10.1. java.sql.Statement</a></li>
<li><a href="#org3b6d854">10.2. java.sql.PreparedStatement</a></li>
<li><a href="#org55a5876">10.3. Lecture des résultats d'une requête SELECT</a></li>
<li><a href="#org63f18a2">10.4. Exemple de relation Many to Many, table d'associations</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org1abfe0d" class="outline-2">
<h2 id="org1abfe0d"><span class="section-number-2">1</span> Types de clients</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgfcece04" class="outline-3">
<h3 id="orgfcece04"><span class="section-number-3">1.1</span> Clients SQL génériques</h3>
</div>

<div id="outline-container-org121b071" class="outline-3">
<h3 id="org121b071"><span class="section-number-3">1.2</span> Clients spécifiques à une base de données</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<a href="https://www.pgadmin.org/">https://www.pgadmin.org/</a>
</p>

<p>
Il est ensuite possible de se connecter à
<code>horton.elephantsql.com@5432</code> avec le login <code>vnzaekhx</code> et le mot de
passe <code>oWN4ryvxxdjYWsko1u3WTW23k6yB7bM9</code> à la base de données du même
nom que le login. Pour travailler, il est recommandé de :
</p>

<ul class="org-ul">
<li>créer votre propre base de données avec votre propre compte gratuit
sur <a href="https://www.elephantsql.com/">https://www.elephantsql.com/</a>.</li>
<li><a href="https://doc.ubuntu-fr.org/postgresql">installer postgresql</a> sur son poste de travail.</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org384b6e2" class="outline-2">
<h2 id="org384b6e2"><span class="section-number-2">2</span> Requêtes SQL</h2>
<div class="outline-text-2" id="text-2">
<p>
On peut effectuer des requêtes sur la base de données, soit à partir d'une
console dédiée, soit à partir d'un programme. Les requêtes sont exprimées dans
un langage spécifique, le <b>SQL</b>. Dans un premier temps, on effectuera les
requêtes à partir de consoles dédiées, puis on verra comment effectuer des
requêtes à partir d'un programme Java. Ensuite, on verra comment utiliser une
base de données avec un programme Java sans avoir forcément besoin d'écrire des
requêtes. En effet, la construction d'objets et même de collection d'objets, ou
leur persistance peut être automatisée par un <b>ORM</b>. 
Finalement, on verra que l'on peut, à l'intérieur
d'un programme Java, écrire des requêtes dans un autre langage, <b>JPQL</b>, qui
permet d'avoir la flexibilité d'un langage tout en gardant les facilités introduites par un ORM.
</p>
</div>

<div id="outline-container-orgce9a4db" class="outline-3">
<h3 id="orgce9a4db"><span class="section-number-3">2.1</span> Sources de données</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Le langage SQL permet de sélectionner des données issues d'une source avec la
clause <code>SELECT</code>. Avec la table <code>cities</code> comme source de données, on peut
sélectionner toutes les données avec la requête SQL :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities;
</pre>
</div>

<p>
Le <code>*</code> indique que les données de toutes les colonnes doivent être retournées.
On remarque, par rapport aux données stockées dans le fichier de la session
précédente qui servent à initialiser les attributs des objets de la class
<code>City</code>, qu'il y a en plus une colonne <code>id</code>. Celle-ci permet d'avoir une notion
d'<i>identité</i> pour les enregistrements (lignes) d'une table (même que la
référence sur un objet en Java) distincte de l'<i>égalité</i>. En base de données
relationnelles, on parle de <i>clé primaire</i> d'un table pour désigner la colonne
qui sert d'identifiant. On reviendra sur cette notion lors de la création de tables, en XXX.
</p>

<p>
On peut aussi ne spécifier que les colonnes qui nous intéressent, et indiquer
l'ordre dans lesquelles les informations de chaque ligne doivent être retournées :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> latitude, longitude, <span style="color: #0000FF;">name</span>
<span style="color: #0000FF;">FROM</span> cities;
</pre>
</div>


<p>
Une base de données relationnelle peut bien évidemment, contenir plusieurs tables.
Par exemple, la base contient une table <code>regions_name</code> avec les régions et le nom de leur capitale :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> regions_name;
</pre>
</div>

<p>
On peut sélectionner des données à partir de plusieurs tables, le résultat étant
alors le produit cartésien (c'est-à-dire toutes les combinaisons possibles!) des
différentes tables. L :
</p>
<div class="org-src-container">
<pre class="src src-sql"> <span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> regions_name, cities;
</pre>
</div>

<p>
Cette requête retourne 643796 lignes!
Bien sûr, en pratique, on utilisera le plus souvent pas toutes les lignes du produit cartésien entre deux table, mais on effectuera une <i>sélection</i> selon les valeurs de colonnes (et leurs relations).
On verra notamment la notion de <i>jointure</i> à l'aide d'une <i>clé étrangère</i>.
</p>


<p>
 De plus, celles-ci ne sont pas très
lisibles car il y a deux colonnes <code>id</code> et deux colonnes <code>names</code>, une pour
chacune des tables. Si l'on veut désigner une colonne, on peut (et on doit dans
le cas de même nom dans plusieurs tables, comme pour <code>id</code> et <code>name</code>), préfixer
le nom de colonne par le nom de la table :
</p>
<div class="org-src-container">
<pre class="src src-sql"> <span style="color: #0000FF;">SELECT</span> regions_name.<span style="color: #0000FF;">name</span>, regions_name.capital_name, cities.<span style="color: #0000FF;">name</span>, cities.longitude, cities.latitude <span style="color: #0000FF;">from</span> regions_name , cities;
</pre>
</div>

<p>
Pour éviter de réécrire à chaque fois tout le nom de la table pour chaque préfixe, on peut à la place désigner un <i>alias</i> pour les sources de données :
</p>

<div class="org-src-container">
<pre class="src src-sql"> <span style="color: #0000FF;">SELECT</span> r.<span style="color: #0000FF;">name</span>, capital_name, c.<span style="color: #0000FF;">name</span>, c.longitude,c.latitude <span style="color: #0000FF;">from</span> regions_name <span style="color: #0000FF;">as</span> r, cities <span style="color: #0000FF;">as</span> c;
</pre>
</div>

<p>
On peut aussi donner des noms aux colonnes du résultat avec le même mot-clé <i>as</i> :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> regions_name.<span style="color: #0000FF;">name</span> <span style="color: #0000FF;">as</span> r_name, regions_name.capital_name <span style="color: #0000FF;">as</span> r_cname, cities.<span style="color: #0000FF;">name</span>, cities.longitude, cities.latitude <span style="color: #0000FF;">from</span> regions_name , cities;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf0ff4af" class="outline-3">
<h3 id="orgf0ff4af"><span class="section-number-3">2.2</span> Expressions</h3>
<div class="outline-text-3" id="text-2-2">
<p>
En fait, chaque colonne de résultat peut être une expression en fonction de 0 ou plusieurs des colonnes de la ou des source(s) de données :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> <span style="color: #006FE0;">LOWER</span>(<span style="color: #0000FF;">name</span>), <span style="color: #006FE0;">UPPER</span>(capital_name), CONCAT(<span style="color: #0000FF;">name</span>, <span style="color: #008000;">' / '</span>,capital_name), 10 <span style="color: #0000FF;">from</span> regions_name;
</pre>
</div>

<p>
Lorsque l'on utilise une ou des expressions ne faisant pas intervenir de colonnes de la ou des sources de données, on peut ne pas avoir de source de données du tout :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> 10 <span style="color: #0000FF;">as</span> longitude_ref, 4 <span style="color: #0000FF;">as</span> latitude_ref;
</pre>
</div>

<p>
Finalement, on pourra utiliser un résultat de sélection comme une source de données à la place d'une table, en donnant un alias à ce résultat :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> cstes.long, cstes.lat <span style="color: #0000FF;">FROM</span> (<span style="color: #0000FF;">SELECT</span> 10 <span style="color: #0000FF;">as</span> long, 4 <span style="color: #0000FF;">as</span> lat) <span style="color: #0000FF;">as</span> cstes;
</pre>
</div>

<p>
Il est donc possible de composer des requêtes SQL, par exemple pour retourner les noms de villes et leurs distances par rapport à une longitude/latitude de référence :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> <span style="color: #0000FF;">name</span>
, (6371* acos(cos(radians(<span style="color: #6434A3;">ref</span>.latitude))) * cos(radians(cities.latitude)) * cos(radians(cities.longitude) - radians(<span style="color: #6434A3;">ref</span>.longitude))
+sin(radians(cities.latitude)) * sin(radians(cities.latitude))) <span style="color: #0000FF;">AS</span> distance
        <span style="color: #0000FF;">FROM</span> cities
    ,(<span style="color: #0000FF;">SELECT</span> 48.8 <span style="color: #0000FF;">AS</span> latitude, 2.4333 <span style="color: #0000FF;">AS</span> longitude) <span style="color: #0000FF;">AS</span> <span style="color: #6434A3;">ref</span>;
</pre>
</div>

<p>
Afin de gagner en lisibilité, on peut composer les sélections sans pour autant les imbriquer, à l'aide de la formulation <a href="https://www.postgresql.org/docs/current/static/queries-with.html">WITH</a> :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">WITH</span> <span style="color: #6434A3;">ref</span> <span style="color: #0000FF;">AS</span> (<span style="color: #0000FF;">SELECT</span> 48.8 <span style="color: #0000FF;">AS</span> latitude, 2.4333 <span style="color: #0000FF;">AS</span> longitude)
<span style="color: #0000FF;">SELECT</span> <span style="color: #0000FF;">name</span>
, (6371* acos(cos(radians(<span style="color: #6434A3;">ref</span>.latitude))) * cos(radians(cities.latitude)) * cos(radians(cities.longitude) - radians(<span style="color: #6434A3;">ref</span>.longitude))
+sin(radians(cities.latitude)) * sin(radians(cities.latitude))) <span style="color: #0000FF;">AS</span> distance
        <span style="color: #0000FF;">FROM</span> cities, <span style="color: #6434A3;">ref</span>;
</pre>
</div>
</div>
</div>


<div id="outline-container-org4a047f5" class="outline-3">
<h3 id="org4a047f5"><span class="section-number-3">2.3</span> Tris : clause ORDER BY</h3>
<div class="outline-text-3" id="text-2-3">
<p>
On peut trier les lignes de résultat en fonction d'une ou plusieurs expressions en fonction des valeurs des colonnes grâce à la clause <a href="https://www.postgresql.org/docs/current/static/queries-order.html">ORDER</a> :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> regions_name <span style="color: #0000FF;">ORDER</span> <span style="color: #0000FF;">BY</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">ASC</span>;
</pre>
</div>

<p>
On peut classer par ordre croissant (<code>ASC</code>) ou décroissant (<code>DESC</code>). Si plusieurs critères de classement sont indiqués (séparés par des virgules)
, ils sont appliqués de façon à ce qu'un critère serve à classer les lignes qui sont équivalentes selon les crières précédents.
</p>
</div>
</div>

<div id="outline-container-org08a93e7" class="outline-3">
<h3 id="org08a93e7"><span class="section-number-3">2.4</span> Limitation du nombre de résultats : clause LIMIT et OFFSET</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Il est possible de ne récupérer qu'une partie des résultats d'une requête grâce
aux clauses <a href="https://www.postgresql.org/docs/current/static/queries-limit.html">LIMIT et OFFSET</a>. <code>LIMIT</code> permet de ne récpérer qu'un nombre limité
de résultats. Par exemple pour ne récupérer que 10 lignes :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">LIMIT</span> 10;
</pre>
</div>

<p>
La clause <code>OFFSET</code> permet, elle, de ne considérer les résultats qu'après avoir passé un nombre de lignes données.
Les deux clauses peuvent être combinées pour implémenter une pagination. Par exemple, on peut récupérer 10 résultats après avoir passé les 10 premiers :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">LIMIT</span> 10 OFFSET 10;
</pre>
</div>

<p>
Bien sûr, ces clauses sont le plus utiles lorsqu'elles sont combinées avec une clause de classement :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">ORDER</span> <span style="color: #0000FF;">BY</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">ASC</span> <span style="color: #0000FF;">LIMIT</span> 10 OFFSET 10;
</pre>
</div>

<p>
Voire :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">WITH</span> <span style="color: #6434A3;">ref</span> <span style="color: #0000FF;">AS</span> (<span style="color: #0000FF;">SELECT</span> 48.8 <span style="color: #0000FF;">AS</span> latitude, 2.4333 <span style="color: #0000FF;">AS</span> longitude)
<span style="color: #0000FF;">SELECT</span> <span style="color: #0000FF;">name</span>
, (6371* acos(sin(radians(<span style="color: #6434A3;">ref</span>.latitude)) * sin(radians(cities.latitude)) + cos(radians(cities.latitude)) * cos(radians(<span style="color: #6434A3;">ref</span>.latitude)) *
 cos( radians(<span style="color: #6434A3;">ref</span>.longitude) - radians(cities.longitude)))
+sin(radians(cities.latitude)) * sin(radians(cities.latitude))) <span style="color: #0000FF;">AS</span> distance
        <span style="color: #0000FF;">FROM</span> cities, <span style="color: #6434A3;">ref</span> <span style="color: #0000FF;">ORDER</span> <span style="color: #0000FF;">BY</span> distance <span style="color: #0000FF;">ASC</span> <span style="color: #0000FF;">LIMIT</span> 10;
</pre>
</div>

<p>
En traduisant en SQL la fonction de distance entre coordonnées GPS basée sur la
   <a href="https://fr.wikipedia.org/wiki/Loi_des_cosinus#En_g.C3.A9om.C3.A9trie_sph.C3.A9rique">loi des cosinus en coordonnées sphériques</a> .
Avec une formule plus précise de <a href="https://fr.wikipedia.org/wiki/Distance_du_grand_cercle">Distance du grand cercle</a>, on a :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">WITH</span> <span style="color: #6434A3;">ref</span> <span style="color: #0000FF;">AS</span> (<span style="color: #0000FF;">SELECT</span> 48.8 <span style="color: #0000FF;">AS</span> latitude, 2.4333 <span style="color: #0000FF;">AS</span> longitude),
delta_radians <span style="color: #0000FF;">AS</span> (<span style="color: #0000FF;">SELECT</span> <span style="color: #0000FF;">name</span>, latitude, longitude, radians(cities.latitude - <span style="color: #6434A3;">ref</span>.latitude) <span style="color: #0000FF;">as</span> delta_latitude, radians(cities.longitude - <span style="color: #6434A3;">ref</span>.longitude) <span style="color: #0000FF;">as</span> delta_longitude <span style="color: #0000FF;">FROM</span> cities, <span style="color: #6434A3;">ref</span>),
sin_dr <span style="color: #0000FF;">AS</span> ( <span style="color: #0000FF;">SELECT</span> <span style="color: #0000FF;">name</span>, latitude, longitude, sin(dr.delta_latitude/2) <span style="color: #0000FF;">as</span> lat, sin(dr.delta_longitude/2) <span style="color: #0000FF;">as</span> long <span style="color: #0000FF;">FROM</span> delta_radians <span style="color: #0000FF;">as</span> dr),
tmp <span style="color: #0000FF;">AS</span> (<span style="color: #0000FF;">SELECT</span> <span style="color: #0000FF;">name</span>, sin_dr.lat * sin_dr.lat + cos(radians(sin_dr.latitude)) * cos(radians(<span style="color: #6434A3;">ref</span>.latitude)) * sin_dr.long * sin_dr.long <span style="color: #0000FF;">as</span> a <span style="color: #0000FF;">FROM</span> sin_dr, <span style="color: #6434A3;">ref</span>)
<span style="color: #0000FF;">SELECT</span> <span style="color: #0000FF;">name</span>
, (6371 * 2 * atan2(sqrt(a), sqrt(1-a))) <span style="color: #0000FF;">as</span> distance
        <span style="color: #0000FF;">FROM</span> tmp <span style="color: #0000FF;">ORDER</span> <span style="color: #0000FF;">BY</span> distance <span style="color: #0000FF;">ASC</span> <span style="color: #0000FF;">LIMIT</span> 10;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9a3512b" class="outline-3">
<h3 id="org9a3512b"><span class="section-number-3">2.5</span> Sélection de lignes : clause WHERE</h3>
</div>
</div>




<div id="outline-container-org4cba525" class="outline-2">
<h2 id="org4cba525"><span class="section-number-2">3</span> Création de la table cities</h2>
<div class="outline-text-2" id="text-3">
<p>
En fait, on va créer la table <code>cities</code> sur le serveur Postgresql distant à partir d'une sélection des colonnes d'une table d'une base de données existante.
La table source sera sur le serveur MySQL distant hébergé gratuitement à <code>jdbc:mysql://db4free.net:3306/random_user</code> avec les login est mot de passe :
<code>random_user</code> et <code>1mot2passe</code>, à partir des donnés mises à disposition par <a href="http://sql.sh/736-base-donnees-villes-francaises">données mises à disposition par Tony Archambeau</a>.
</p>

<p>
La table destination sera sur le serveur Postgresql distant vu plus haut XXX.
</p>

<p>
On va créer la table city sur le serveur postgresql avec la commande SQL suivante :
</p>



<div class="org-src-container">
<pre class="src src-sql">      <span style="color: #0000FF;">CREATE</span> <span style="color: #0000FF;">TABLE</span> <span style="color: #006699;">cities</span> (
      id SERIAL <span style="color: #0000FF;">PRIMARY</span> <span style="color: #0000FF;">KEY</span>,
      <span style="color: #0000FF;">name</span> <span style="color: #6434A3;">VARCHAR</span>(255) <span style="color: #0000FF;">NOT</span> <span style="color: #0000FF;">NULL</span>,
      departement <span style="color: #6434A3;">VARCHAR</span>(3),
      postal_codes <span style="color: #6434A3;">VARCHAR</span>(255),
      pop_1999 <span style="color: #6434A3;">INTEGER</span> <span style="color: #0000FF;">CHECK</span> (pop_1999 &gt;= 0),
      pop_2010 <span style="color: #6434A3;">INTEGER</span> <span style="color: #0000FF;">CHECK</span> (pop_2010 &gt;= 0),
      pop_2012 <span style="color: #6434A3;">INTEGER</span> <span style="color: #0000FF;">CHECK</span> (pop_2012 &gt;= 0),
      area <span style="color: #6434A3;">DOUBLE</span> <span style="color: #6434A3;">PRECISION</span>  <span style="color: #0000FF;">CHECK</span> (area &gt;= 0.),
      longitude <span style="color: #6434A3;">DOUBLE</span> <span style="color: #6434A3;">PRECISION</span> <span style="color: #0000FF;">NOT</span> <span style="color: #0000FF;">NULL</span>,
      latitude <span style="color: #6434A3;">DOUBLE</span> <span style="color: #6434A3;">PRECISION</span> <span style="color: #0000FF;">NOT</span> <span style="color: #0000FF;">NULL</span>,
      z_min <span style="color: #6434A3;">INTEGER</span>,
      z_max <span style="color: #6434A3;">INTEGER</span>,
      <span style="color: #0000FF;">CHECK</span> (z_min &lt;= z_max));
</pre>
</div>


<ul class="org-ul">
<li>La colonne <code>id</code> est une clé primaire (<i>PRIMARY KEY</i>) qui permet donc
l'identification de chaque ligne de la table. On laissera la base de données
attribuer une valeur unique à chaque nouvelle ligne ajoutée à la table (on
mettra <code>DEFAULT</code> en valeur). On indique à la base d'utiliser des valeurs
entières successives (<code>SERIAL</code>). La base de donnée s'assure que les valeurs
des identifiants sont uniques dans la table : deux lignes ne peuvent pas
avoir la même valeur de clé primaire. De plus, comme la recherche d'une ligne
à partir de la valeur de son identifiant doit être très rapide, la clé
primaire est automatiquement associée à un <i>index</i> qui permet d'accélérer les
recherches.</li>
</ul>


<ul class="org-ul">
<li>La colonne <code>name</code> contiendra une chaîne d'au maximum 255 caractères et
n'autorise pas de valeur manquante (<code>NULL</code>).</li>

<li>La colonne <code>departement</code> contiendra une chaîne d'au maximum 3 caractères pour
le code du département de la ville.</li>

<li>la colonne <code>postal_codes</code> contiendra une chaîne d'au maximum 255 caractères
pour stocker le ou les codes postaux de la ville. En cas de plusieurs codes
postaux, ceux-ci sont séparés par le caractère '-'. Ce n'est pas la
représentation la plus pratique d'une liste, et nous verrons en XXX d'autres
solutions.</li>

<li>les colonnes <code>pop_1999</code>, <code>pop_2010</code> et <code>pop_2012</code> contiennent les populations
(si elles sont connues) en 1999, 2010 et 2012 sous la forme de nombres
entiers. Là encore, cette représentation (une colonne par année) a des
inconvénients, notamment l'impossibilité d'ajouter de nouvelles données
lorsqu'elles seront disponibles. On réfléchira à d'autres solutions en XXX.</li>

<li>la colonne <code>area</code> contient la surface de la ville en km² sous la forme d'un
nombre à virgule flottante en double précision.</li>

<li>les colonnes <code>longitude</code> et <code>latitude</code> contiennent les longitude et latitude
en degrés sous la forme de nombres à virgule flottante double précision. Cette
colonne interdit les valeurs manquantes (<code>NULL</code>).</li>

<li>les colonnes <code>z_min</code> et <code>z_max</code> contiennent, lorsqu'elles sont disponibles,
les altitudes minimales et maximales de la ville, sous la forme de nombres
entiers de mètres.</li>
</ul>


<p>
Si une table avec le nom utilisé dans la commande <code>CREATE TABLE</code>
existe déjà, la création échoue.
</p>

<p>
On remarque la correspondance de l'<i>ORM</i> (Object-Relational Mapping) entre
classes et tables et entre colonnes et attributs (et donc entre lignes et
objets). On note les différences suivantes :
</p>

<ul class="org-ul">
<li>la notion de <i>clé primaire</i> qui est nécessaire, en plus des colonnes pour les
attributs, afin de gérer l'identité des enregistrements.</li>
<li>le fait qu'en plus d'avoir des types, les colonnes peuvent avoir des
contraintes, notamment :
<ul class="org-ul">
<li>sur chaque valeur, par exemple le fait de pouvoir être une valeur manquante
ou non, ou sur le domaine de validité (par exemple le fait d'être
une valeur positive).</li>
<li>sur l'ensemble des valeurs d'une colonne, par exemple la contrainte
d'unicité (implicite pour les clés primaires).</li>
<li>sur plusieurs colonnes, par exemple le fait qu'une valeur doive être
inférieure ou supérieure à une autre. Il est possible, et même recommandé,
de <a href="https://en.wikipedia.org/wiki/Check_constraint">nommer les contraintes</a>, afin d'avoir des messages d'erreur plus
explicites. Attention ! <a href="https://dev.mysql.com/doc/refman/5.7/en/create-table.html">Certaines bases de données ignorent les contraintes
de type CHECK</a> !</li>
</ul></li>
<li>le fait que les chaînes de caractères sont le plus souvent implémentées avec
une taille maximale prédéterminée (pour des raisons de performance). En fait,
certains systèmes de gestion de bases de données proposent un type <code>text</code>
pour stocker des chaînes de caractères sans limite de taille à priori, mais
ce n'est pas un type du standard SQL.</li>
</ul>

<p>
Au niveau des chaînes de caractères, contrairement à Java, il y a <a href="https://www.postgresql.org/docs/current/static/multibyte.html">plusieurs
possibilités d'encodage</a>. On s'assurera en général d'utiliser le plus standard :
UTF-8.
</p>

<p>
À titre d'exercice, on peut créer d'autres tables, par exemple avec des contraintes nommées.
</p>
</div>
</div>

<div id="outline-container-org355b2dc" class="outline-2">
<h2 id="org355b2dc"><span class="section-number-2">4</span> Destruction de table</h2>
<div class="outline-text-2" id="text-4">
<p>
On peut détruire une table avec l'instruction <code>DROP TABLE</code> :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">CREATE</span> <span style="color: #0000FF;">TABLE</span> <span style="color: #006699;">to_drop</span>(id SERIAL <span style="color: #0000FF;">PRIMARY</span> <span style="color: #0000FF;">KEY</span>);
<span style="color: #0000FF;">DROP</span> <span style="color: #0000FF;">TABLE</span> <span style="color: #006699;">to_drop</span>;
</pre>
</div>

<p>
<b>Attention !</b> Il y'a pas de possibilité de revenir en arrière sur l'effacement
d'une table. Bien s'assurer qu'on efface bien la table voulue (et qu'on est bien
sur le serveur de base de données voulu, pas sur le serveur de production plutôt
que sur celui de développement ou de test !).
</p>
</div>
</div>

<div id="outline-container-org81b1ed3" class="outline-2">
<h2 id="org81b1ed3"><span class="section-number-2">5</span> Insertions dans la table cities</h2>
<div class="outline-text-2" id="text-5">
<p>
On va ajouter une ville dans la base, par exemple le village disparu <a href="https://fr.wikipedia.org/wiki/Ailles">Ailles</a> avec
les informations suivantes :
</p>
<dl class="org-dl">
<dt>nom</dt><dd>Ailles</dd>
<dt>département</dt><dd>02</dd>
<dt>populations</dt><dd>0 pour toutes les années considérées</dd>
<dt>superficie</dt><dd>4.69 km²</dd>
<dt>longitude</dt><dd>4.1528</dd>
<dt>latitude</dt><dd>49.3493</dd>
</dl>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">INSERT</span> <span style="color: #0000FF;">INTO</span> cities <span style="color: #0000FF;">VALUES</span>(<span style="color: #0000FF;">DEFAULT</span>, <span style="color: #008000;">'Ailles'</span>, <span style="color: #008000;">'02'</span>, <span style="color: #0000FF;">NULL</span>, 0,0,0, 4.69, 4.1528, 49.3493, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>);
</pre>
</div>


<p>
On peut vérifier qu'une tentative d'insertion de valeurs ne respectant pas les
contraintes est rejetée (sous réserve que l'on utilise pas
 <a href="https://dev.mysql.com/doc/refman/5.7/en/create-table.html">un SGDBR qui ignore certaines contraintes</a> :
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">INSERT</span> <span style="color: #0000FF;">INTO</span> cities <span style="color: #0000FF;">VALUES</span>(<span style="color: #0000FF;">DEFAULT</span>, <span style="color: #008000;">'longitude invalide'</span>, <span style="color: #008000;">'02'</span>, <span style="color: #0000FF;">NULL</span>, 0,0,0, 4.69, <span style="color: #0000FF;">NULL</span>, 49.3493, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>);
</pre>
</div>

<p>
À titre d'exercice, on peut vérifier l'erreur provoquée par la tentative
d'insertion d'une ligne dont le département est invalide, soit pour une erreur
de type, soit parce que la chaîne de caractères serait trop longue.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">INSERT</span> <span style="color: #0000FF;">INTO</span> cities <span style="color: #0000FF;">VALUES</span>(<span style="color: #0000FF;">DEFAULT</span>, <span style="color: #008000;">'pop invalide'</span>, <span style="color: #008000;">'02'</span>, <span style="color: #0000FF;">NULL</span>, -1,0,0, 4.69, 4.1528, 49.3493, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>);
</pre>
</div>

<p>
et
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">INSERT</span> <span style="color: #0000FF;">INTO</span> cities <span style="color: #0000FF;">VALUES</span>(<span style="color: #0000FF;">DEFAULT</span>, <span style="color: #008000;">'z invalides'</span>, <span style="color: #008000;">'02'</span>, <span style="color: #0000FF;">NULL</span>, 0,0,0, 4.69, 4.1528, 49.3493, 1, -1);
</pre>
</div>

<p>
Pour ces dernières contraintes, le message d'erreur sera plus ou moins explicite
selon qu'on aura ou non nommé la contrainte violée.
</p>


<p>
On va aussi ajouter des villes imaginaires afin de pouvoir faire des modifications sans invalider des données réelles :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">INSERT</span> <span style="color: #0000FF;">INTO</span> cities <span style="color: #0000FF;">VALUES</span>(<span style="color: #0000FF;">DEFAULT</span>, <span style="color: #008000;">'Ville d''en haut'</span>, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>, 100, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>, 4.69, 5.0, 50.0, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>);
<span style="color: #0000FF;">INSERT</span> <span style="color: #0000FF;">INTO</span> cities <span style="color: #0000FF;">VALUES</span>(<span style="color: #0000FF;">DEFAULT</span>, <span style="color: #008000;">'Ville d''en bas'</span>, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>, 100, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>, 4.69, 5.0, 50.0, <span style="color: #0000FF;">NULL</span>, <span style="color: #0000FF;">NULL</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org320e343" class="outline-2">
<h2 id="org320e343"><span class="section-number-2">6</span> Suppression</h2>
<div class="outline-text-2" id="text-6">
<p>
On peut supprimer la première ville que l'on a ajoutée de la façon suivante :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">DELETE</span> <span style="color: #0000FF;">FROM</span> cities <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span>=<span style="color: #008000;">'Ailles'</span>;
</pre>
</div>

<p>
Attention, si la clause <code>WHERE</code> sélectionne plusieurs lignes, elles seront
toutes effacées. <b>Attention !</b> En l'abscence de clause <code>WHERE</code>, <b>TOUTES LES
LIGNES SERONT EFFACÉES !</b>
</p>

<p>
En pratique, il est souvent plus prudent de faire un <code>SELECT</code> avec la clause
<code>WHERE</code> pour s'assurer que l'on ne sélectionne pas plus de lignes que prévu.
Ensuite, on remplace le <code>SELECT</code> par un <code>DELETE</code> sans toucher à la clause
<code>WHERE</code> pour être sûr que ce sont bien les mêmes lignes qui seront effacées.
</p>
</div>
</div>


<div id="outline-container-org742ed79" class="outline-2">
<h2 id="org742ed79"><span class="section-number-2">7</span> Modification dans la table cities</h2>
<div class="outline-text-2" id="text-7">
<p>
Supposons que l'on veuille modifier les valeurs d'un ou plusieurs attributs, par
exemple pour modifier la valeur de la population en 2010 d'une ville que l'on a ajoutée :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">UPDATE</span> cities <span style="color: #0000FF;">SET</span> pop_2010= 1000 <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span>=<span style="color: #008000;">'Ville d''en haut'</span>;
</pre>
</div>
<p>
On peut bien sûr utiliser n'importe quelle expression pour la nouvelle valeur,
en utilisant éventuellement les valeurs de la ligne modifiée :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">UPDATE</span> cities <span style="color: #0000FF;">SET</span> pop_2010= pop_2010 + 0.5 * pop_1999 <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span>=<span style="color: #008000;">'Ville d''en haut'</span>;
</pre>
</div>

<p>
On peut aussi modifier plusieurs lignes à la fois lorsque la clause <code>WHERE</code> en sélectionne plus d'une :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">UPDATE</span> cities <span style="color: #0000FF;">SET</span> pop_2012= 2 * pop_1999 +1 <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'Ville d''en %'</span>;
</pre>
</div>

<p>
<b>Attention !</b> En l'absence de clause <code>WHERE</code>, ce sont <b>toutes les lignes</b> de la table qui seront modifiées !
</p>
</div>
</div>

<div id="outline-container-org5cc8a75" class="outline-2">
<h2 id="org5cc8a75"><span class="section-number-2">8</span> Notion de transaction</h2>
<div class="outline-text-2" id="text-8">
<p>
On peut vouloir faire plusieurs modifications "en même temps", ou plus
exactement de façon atomique. C'est-à-dire que l'ensemble des modifications soit
effectué ou alors qu'aucune modification ne soit effectuée. On peut utiliser
pour cela une <i>transaction</i>. On commence explicitement une transaction avec
l'instruction SQL <code>START TRANSACTION</code> et ensuite, si tout c'est bien passé en enregistre les
résultats de la transaction avec l'instruction SQL <code>COMMIT</code>. En cas d'erreur, on
peut annuler tout ce qui a été fait depuis le début de la transaction avec
l'instruction <code>ROLLBACK</code>.
</p>

<p>
Attention ! La plupart des consoles permettant d'envoyer des commandes SQL à un
SGBDR sont en mode 'auto-commit' où chaque instruction est considérée comme
étant dans une transaction terminée par un commit. Pour tester les effets d'une
transaction explicite, il est nécessaire de désactiver l'auto-commit.
</p>

<p>
Par exemple, si l'on veut déplacer 75 personnes de la population de 'Ville d'en
haut' en 1999 vers la population de 'Ville d'en bas' la même année :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'%Ville d''en %'</span>;
<span style="color: #0000FF;">START</span> <span style="color: #0000FF;">TRANSACTION</span>;
<span style="color: #0000FF;">UPDATE</span> cities <span style="color: #0000FF;">SET</span> pop_1999= pop_1999 + 75 <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> = <span style="color: #008000;">'Ville d''en bas'</span>;
<span style="color: #0000FF;">UPDATE</span> cities <span style="color: #0000FF;">SET</span> pop_1999= pop_1999 - 75 <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> = <span style="color: #008000;">'Ville d''en haut'</span>;
<span style="color: #0000FF;">COMMIT</span>;
<span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'%Ville d''en %'</span>;
</pre>
</div>

<p>
Mais si l'on essaie répéter ces opérations une deuxième fois (pourvu que la
population de 'Ville d'en haut' soit trop faible et que les contraintes
d'intégrité soient honorées), la deuxième instruction sera rejetée :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'%Ville d''en %'</span>;
<span style="color: #0000FF;">START</span> <span style="color: #0000FF;">TRANSACTION</span>;
<span style="color: #0000FF;">UPDATE</span> cities <span style="color: #0000FF;">SET</span> pop_1999= pop_1999 + 75 <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> = <span style="color: #008000;">'Ville d''en bas'</span>;
<span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'%Ville d''en %'</span>;
<span style="color: #0000FF;">UPDATE</span> cities <span style="color: #0000FF;">SET</span> pop_1999= pop_1999 - 75 <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> = <span style="color: #008000;">'Ville d''en haut'</span>;
</pre>
</div>
<p>
On peut vérifier que la première a bien eu un effet avec une instruction
<code>SELECT</code>, mais on peut revenir en arrière sur cette modification à l'aide d'un <code>ROLLBACK</code> :
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'%Ville d''en %'</span>;
<span style="color: #0000FF;">ROLLBACK</span>;
<span style="color: #0000FF;">SELECT</span> * <span style="color: #0000FF;">from</span> cities <span style="color: #0000FF;">WHERE</span> <span style="color: #0000FF;">name</span> <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'%Ville d''en %'</span>;
</pre>
</div>


<p>
Attention ! On pourrait être tenté de vouloir vérifier à l'avance si un ensemble
de modifications sera possible sans violations de contraintes. C'est cependant
impossible dans le contexte d'un <b>serveur</b> de bases de données. En effet, entre
l'instant où l'on vérifie une condition et celui où on effectue une modification
en fonction de cette condition, les données de la base peut avoir été modifiées
! La seule façon de savoir si une modification peut être faite sans violation de
contrainte, c'est d'essayer de faire la modification et de constater si elle a
pu être effectuée ou non. D'où la nécessité d'utiliser des transactions si
plusieurs modifications doivent être toutes effectuées ensemble ou aucune ne
doit être effectuée si l'une d'elles échoue.
</p>
</div>
</div>



<div id="outline-container-org95e7502" class="outline-2">
<h2 id="org95e7502"><span class="section-number-2">9</span> Utilisation de SGBDR en Java : préliminaires</h2>
<div class="outline-text-2" id="text-9">
<p>
Les SGDBR et leurs drivers Java permettent différents niveaux de
fonctionnalités. Dans un soucis de simplicité et de compatibilité maximale, on
ne s'intéresse ici qu'aux fonctionnalités les plus basiques dont la
disponibilité est garantie. En cas de besoin, et si le SGDBR est connu et fixé,
on pourra utiliser <a href="https://docs.oracle.com/javase/tutorial/jdbc/basics/retrieving.html">des fonctionnalités plus avancées</a>.
</p>
</div>

<div id="outline-container-orga22d5d0" class="outline-3">
<h3 id="orga22d5d0"><span class="section-number-3">9.1</span> Chargement de drivers</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Tout d'abord, il faut utiliser le(s) driver(s) JDBC (Java DataBase Connectivity)
adapté(s) au(x) SGBDR utilisé(s).
</p>

<p>
Ensuite, il faut rendre les drivers accessibles au programme Java.
Habituellement, il suffit d'utiliser <code>import</code> pour utiliser n'importe quelle
classe (sous réserve qu'elle soit disponible dans le <code>CLASSPATH</code> lors de la
compilation et de l'exécution du programme.
</p>

<p>
Dans le cas des classes de drivers JDBC, on veut pouvoir choisir le SGDBR, et
donc le driver, à l'exécution et non à la compilation. En effet, on peut vouloir
utiliser différents SGDBR en environnement de test et en production. Évidemment,
il faut que ce soit le même programme compilé qui soit exécuté en test et en
production. Pour la même raison, parce que les URL d'accès au SGBDR et les
comptes (login et mot de passe associé) ne sont pas forcément les mêmes en test
et en production, on fera aussi en sorte que ces informations soient aussi
paramétrables sans recompilation, donc hors du code source.
</p>

<p>
En fait, pour les mots de passe, il est aussi essentiel de ne jamais les écrire
dans un code source. En effet, les codes sources sont souvent diffusés
largement, notamment par des systèmes de gestion de version et doivent donc
contenir aucune information confidentielle. Par exemple, lorsqu'on stocke des
informations confidentielles dans un fichier .properties dans un projet géré par
git, il est essentiel d'exclure ce fichier de la gestion de version à l'aide de
<a href="https://git-scm.com/docs/gitignore">gitignore</a>.
</p>


<p>
Pour que les classes des drivers JDBC soient chargées dynamiquement (à
l'exécution), il faut exécuter la méthode statique <code>forName</code> de la classe <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html">Class</a>  :
</p>

<ul class="org-ul">
<li>pour Postgresql :</li>
</ul>
<div class="org-src-container">
<pre class="src src-java">Class.forName(<span style="color: #008000;">"org.postgresql.Driver"</span>);
</pre>
</div>
<ul class="org-ul">
<li>pour H2 :</li>
</ul>
<div class="org-src-container">
<pre class="src src-java">Class.forName(<span style="color: #008000;">"org.h2.Driver"</span>);
</pre>
</div>
<ul class="org-ul">
<li>pour MySQL :</li>
</ul>
<div class="org-src-container">
<pre class="src src-java">Class.forName(<span style="color: #008000;">"com.mysql.jdbc.Driver"</span>);
</pre>
</div>

<p>
Cet appel de méthode peut lancer une exception de type <code>ClassNotFoundException</code>
qu'il faut donc gérer.
</p>

<p>
Ensuite, le driver correspondant au SGBDR sera choisi en fonction de l'URL de
connection à la base. Cette URL étant dans une chaîne de caractères, elle est
donc aussi configurable à l'exécution.
</p>
</div>
</div>

<div id="outline-container-orgdbb0b48" class="outline-3">
<h3 id="orgdbb0b48"><span class="section-number-3">9.2</span> Établissement de la connection au SGBDR</h3>
<div class="outline-text-3" id="text-9-2">
<p>
La connection au SGDBR est matérialisée par un objet instance d'une classe
implémentant l'interface <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html">java.sql.Connection</a> . Cette connection peut être en
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#getAutoCommit()">mode autocommit ou non</a>. On récupère cet objet par un appel à la méthode
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/DriverManager.html#getConnection(java.lang.String,%20java.lang.String,%20java.lang.String)">java.sql.DriverManager.getConnection()</a>. Par exemple, si les URL, login et mot de
passe sont stockés dans une <code>Map&lt;String,String&gt; env</code> et assocés aux clés <code>"URL"</code>, <code>"USER"</code> et <code>"PASS"</code> :
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #6434A3;">Connection</span> <span style="color: #BA36A5;">conn</span>= DriverManager.getConnection(env.get(<span style="color: #008000;">"URL"</span>), env.get(<span style="color: #008000;">"USER"</span>), env.get(<span style="color: #008000;">"PASS"</span>));
</pre>
</div>

<p>
L'url étant de la forme "jdbc:SGBD_NAME://DBSERVER_NAME:DBSERVER_PORT/DATABASE_NAME".
</p>

<p>
Il faudra s'assurer que la connection sera fermée à un appel à la méthode
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#close()">close()</a>. On remarque que l'interface <code>java.sql.Connection</code> hérite de l'interface
<code>java.lang.AutoClosable</code>, ce qui implique donc qu'on peut faire l'initialisation
dans un bloc <code>try(){}</code> (dit «try with resources»). Attention : cette méthode
<code>.close()</code> peut elle-même lancer une <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/SQLException.html">SQLException</a> qu'il faut donc aussi gérer.
</p>

<p>
On passera l'objet connection aux différentes méthodes qui s'en serviront pour
interagir avec le SGBDR.
</p>
</div>
</div>
</div>

<div id="outline-container-org635d3f3" class="outline-2">
<h2 id="org635d3f3"><span class="section-number-2">10</span> Utilisation de SGBDR en Java : requêtes SQL</h2>
<div class="outline-text-2" id="text-10">
<p>
Il y a deux façons de faire exécuter des requêtes SQL en Java, suivant qu'on
utilise des <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html">java.sql.Statement</a> ou des <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html">java.sql.PreparedStatement</a>.
</p>
</div>


<div id="outline-container-org8160e5f" class="outline-3">
<h3 id="org8160e5f"><span class="section-number-3">10.1</span> java.sql.Statement</h3>
<div class="outline-text-3" id="text-10-1">
<p>
On commence par créer l'objet par un appel à <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#createStatement()">createStatement()</a> sur l'objet qui
implémente l'interface <code>Connection</code>. Cet objet nouvellement créé devra lui aussi
être fermé par un appel à sa méthode <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#close()">close()</a>. Comme il implémente l'interface
<code>AutoCloseable</code>, on peut créer l'objet dans un <code>try(){}</code> («try with resources»).
</p>

<p>
Ensuite, on peut appeler sur cet objet l'une des méthodes suivante :
</p>

<ul class="org-ul">
<li><a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#execute(java.lang.String)">execute(String sql)</a> pour exécuter la commande SQL passée en paramètre, en
ayant en valeur de retour un booléen indiquant si l'exécution s'est déroulée
sans erreur ou non.</li>
<li><a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#executeUpdate(java.lang.String)">executeUpdate(String sql)</a> pour exécuter la commande SQL passée en paramètre,
en ayant en valeur de retour le nombre de lignes modifiées (comme son nom
l'indique, on utilise cette méthode pour des commandes SQL <code>UPDATE</code>).</li>
<li><a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#executeQuery(java.lang.String)">executeQuery(String sql)</a> pour exécuter la commande SQL passée en paramètre, en
ayant en valeur de retour un objet implémentant l'interface <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html">java.sql.ResultSet</a>
qui permettra de récupérer les résultat d'une commande SQL <code>SELECT</code>.</li>
</ul>


<p>
De plus, si l'on veut exécuter plusieurs commandes SQL en une seule fois, pour
des raisons de performance, on peut à la place utiliser la méthode
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#addBatch(java.lang.String)">addBatch(String sql)</a> pour chacune des commandes, puis déclencher l'exécution de
toutes celles-ci par un appel à <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#executeBatch()">executeBatch()</a>.
</p>


<p>
Souvent, la commande SQL à exécuter dépend de valeurs qui ne sont connues qu'à
 l'exécution, par exemple les données à ajouter dans un <code>INSERT</code> ou des critères
 d'une clause <code>WHERE</code>. Il est possible de construire dynamiquement la commande
 SQL en concaténant des chaînes de caractères mais il faut alors faire très
 attention au risque d'<a href="https://fr.wikipedia.org/wiki/Injection_SQL">injection SQL</a>. Même sans utilisateurs hostiles, il faut
 de toutes façons prendre en compte l'échappement des caractères spéciaux dans
 une chaîne de caractères. Par exemple, le guillemet simple, utilisé souvernt
 pour l'apostrophe, doit être remplacé par deux guillemets simples pour éviter
 qu'il soit interprété comme la fin de chaîne. On peut faire pour cela un appel comme ceci :
 <code>.replaceAll("'","''")</code>.
</p>


<p>
Il est cependant préférable d'utiliser des <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html">java.sql.PreparedStatement</a> pour ne
pas avoir à gérer soi-même les arguments.
</p>
</div>
</div>



<div id="outline-container-org3b6d854" class="outline-3">
<h3 id="org3b6d854"><span class="section-number-3">10.2</span> java.sql.PreparedStatement</h3>
<div class="outline-text-3" id="text-10-2">
<p>
Toujours à partir de l'objet implémentant l'interface <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html">java.sql.Connection</a>, on
peut utiliser la méthode <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#prepareStatement(java.lang.String)">prepareStatement(String sql)</a> pour créer un objet
implémentant l'interface <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html">java.sql.PreparedStatement</a>. La chaîne de caractère
passée en argument contient le code de la commande SQL avec des '?' à la place
des arguments de la commande. Par exemple, pour insérer une nouvelle ligne dans
notre table <code>cities</code>, on pourra utiliser :
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #6434A3;">String</span> <span style="color: #BA36A5;">insertCmd</span>= <span style="color: #008000;">"INSERT INTO cities VALUES(DEFAULT, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"</span>;
<span style="color: #0000FF;">try</span>(<span style="color: #6434A3;">PreparedStatement</span> <span style="color: #BA36A5;">stmt</span>= conn.prepareStatement(insertCmd)){
}
</pre>
</div>

<p>
Comme pour la création d'un <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html">java.sql.Statement</a>, on peut (devrait ?) utiliser un
<i>try with resources</i> parce que l'objet créé implémente l'interface
<code>java.lang.AutoCloseable</code>.
</p>

<p>
Ensuite, on peut utiliser sur cet objet les méthodes <code>setXXX()</code> comme
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#setDouble(int,%20double)">setDouble(int parameterIndex, double parameterValue)</a> ou <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#setString(int,%20java.lang.String)">setString(int
parameterIndex, String parameterValue)</a> pour donner des valeurs à chacun des
paramètres représentés par un '?' dans la chaîne passée en argument de
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#prepareStatement(java.lang.String)">prepareStatement(String sql)</a>. Attention ! Les <code>parameterIndex</code> commencent à 1 et
non à 0. Si l'on veut insérer une valeur manquante <code>NULL</code>, il faut utiliser la
méthode <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#setNull(int,%20int)">setNull(int parameterIndex, int sqlType)</a>. L'argument <code>sqlType</code> étant
l'une des constantes nommées définies dans la classe <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Types.html">java.sql.Types</a>.
</p>

<p>
Ensuite, une fois que tous les arguments on reçu une valeur, on peut appeler
l'une des méthodes <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#execute()">execute()</a>, <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#executeQuery()">executeQuery()</a> ou <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#executeUpdate()">executeUpdate()</a>. On peut aussi
créer un batch de plusieurs commandes à executer à l'aide des méthodes
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#addBatch()">addBatch()</a> et <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#executeBatch()">executeBatch()</a>.
</p>
</div>
</div>


<div id="outline-container-org55a5876" class="outline-3">
<h3 id="org55a5876"><span class="section-number-3">10.3</span> Lecture des résultats d'une requête SELECT</h3>
<div class="outline-text-3" id="text-10-3">
<p>
Lorsque l'on exécute une requête <code>SELECT</code>, on utilise la méthode <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#executeQuery()">executeQuery()</a>
qui retourne un objet implémentant l'interface <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html">java.sql.ResultSet</a>. Cet objet
permet de récupérer chacunes des données de chacune des lignes correspondant à
la requête. Pour passer à la ligne suivante en testant s'il y en a une, on
utilise la méthode <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html#next()">next()</a> (le plus souvent comme condition de continuation dans
une boucle <code>while()</code> pour traiter toutes les lignes de la première à la
dernière). Ensuite, pour chacune des lignes (à l'intérieur de la boucle, donc),
on peut récupérer la valeur de chacune des colonnes avec des appels aux méthodes
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html#getDouble(java.lang.String)">getDouble(String colName)</a>, <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html#getInt(java.lang.String)">getInt(String colName)</a>, <a href="https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html#getLong(java.lang.String)">getLong(String colName)</a>,
<a href="https://docs.oracle.com/javase/7/docs/api/java/sql/ResultSet.html#getString(java.lang.String)">getString(String colName)</a> et autres. Il est aussi possible de passer des numéros
de colonne en argument plutôt que d'utiliser les noms, mais il faut alors se
souvenir non seulement de l'ordre des colonnes dans le resultat, mais aussi que
leur numérotation commence à 1 et non à 0. Toujours dans un soucis de plus
grande compatibilité avec tous les drivers JDBC disponibles, mais aussi dans un
soucis de performance, il est préférable de se contenter de lire les lignes les
unes après les autres et pour chaque ligne et de ne lire les données qu'une
seule fois pour une instance de <code>ResultSet</code> donnée.
</p>

<p>
Par exemple, pour construire une liste d'objets de classe <code>CityDTO</code> à partir du
résultat d'une requête SQL sur une connection donnée, on pourrait écrire :
</p>
<div class="org-src-container">
<pre class="src src-java">        <span style="color: #0000FF;">private</span> <span style="color: #0000FF;">static</span> <span style="color: #6434A3;">List</span>&lt;<span style="color: #6434A3;">CityDTO</span>&gt; <span style="color: #006699;">readValues</span>(<span style="color: #6434A3;">Connection</span> <span style="color: #BA36A5;">conn</span>){
            <span style="color: #6434A3;">List</span>&lt;<span style="color: #6434A3;">CityDTO</span>&gt; <span style="color: #BA36A5;">res</span>= <span style="color: #0000FF;">new</span> <span style="color: #6434A3;">ArrayList</span>&lt;<span style="color: #6434A3;">CityDTO</span>&gt;();
            <span style="color: #0000FF;">try</span>(<span style="color: #6434A3;">Statement</span> <span style="color: #BA36A5;">stmt</span>= conn.createStatement()){
                <span style="color: #6434A3;">ResultSet</span> <span style="color: #BA36A5;">rs</span>= stmt.executeQuery(readQuery);
                <span style="color: #0000FF;">while</span>(rs.next()){
                    <span style="color: #0000FF;">try</span> {
                    <span style="color: #6434A3;">Float</span> <span style="color: #BA36A5;">villeSurface</span> = (<span style="color: #6434A3;">Float</span>) rs.getObject(<span style="color: #008000;">"ville_surface"</span>);

                        res.add(<span style="color: #0000FF;">new</span> <span style="color: #6434A3;">CityDTO</span>(rs.getString(<span style="color: #008000;">"ville_nom_reel"</span>)
                                            , rs.getString(<span style="color: #008000;">"ville_departement"</span>)
                                            , rs.getString(<span style="color: #008000;">"ville_code_postal"</span>)
                                            , (<span style="color: #6434A3;">Integer</span>)rs.getObject(<span style="color: #008000;">"ville_population_1999"</span>)
                                            , (<span style="color: #6434A3;">Integer</span>)rs.getObject(<span style="color: #008000;">"ville_population_2010"</span>)
                                            , (<span style="color: #6434A3;">Integer</span>)rs.getObject(<span style="color: #008000;">"ville_population_2012"</span>)
                                            , villeSurface == <span style="color: #D0372D;">null</span> ? (Double) <span style="color: #D0372D;">null</span> : <span style="color: #0000FF;">new</span> <span style="color: #6434A3;">Double</span>(villeSurface.doubleValue())
                                            , rs.getDouble(<span style="color: #008000;">"ville_longitude_deg"</span>)
                                            , rs.getDouble(<span style="color: #008000;">"ville_latitude_deg"</span>)
                                            , (<span style="color: #6434A3;">Integer</span>)rs.getObject(<span style="color: #008000;">"ville_zmin"</span>)
                                            , (<span style="color: #6434A3;">Integer</span>)rs.getObject(<span style="color: #008000;">"ville_zmax"</span>)));
                    }<span style="color: #0000FF;">catch</span>(<span style="color: #6434A3;">Exception</span> <span style="color: #BA36A5;">e</span>){
                        System.err.println(e);
                    }
                }
            }<span style="color: #0000FF;">catch</span> (<span style="color: #6434A3;">SQLException</span> <span style="color: #BA36A5;">e</span>){
                System.err.println(e);
            }
            <span style="color: #0000FF;">return</span> res;
        }
</pre>
</div>

<p>
On lit des (références vers des) objets plutôt que des valeurs de types
primitifs lorsque les colonnes peuvent contenir des <code>NULL</code>, auquel cas la
référence retournées est nulle.
</p>


<p>
Il est aussi possible de tirer parti de la correspondance entre tables et
classe, pour automatiser la persistance des objets d'un programme Java. Ceci
grâce à <a href="https://fr.wikipedia.org/wiki/Java_Persistence_API">Java Persistance Api</a>.
</p>
</div>
</div>


<div id="outline-container-org63f18a2" class="outline-3">
<h3 id="org63f18a2"><span class="section-number-3">10.4</span> Exemple de relation Many to Many, table d'associations</h3>
<div class="outline-text-3" id="text-10-4">
<p>
Pour le stockage de l'information concernant les codes postaux de chacune des
villes, le format proposé (une colonne de type chaîne de caractères pouvant
contenir une liste de codes postaux séparés par des '-', n'est ni pratique ni
performant. On va écrire un programme implémentant la relation «Many to Many»
par une table d'associations. Il s'agit d'une relation «Many to Many» car une
ville peut avoir plusieurs codes postaux, mais un code postal peut être associé
à plusieurs villes. Pour représenter cette association, on va créer deux tables :
</p>
<ul class="org-ul">
<li>une table <code>postalcodes</code> qui va contenir la chaîne de caractère du code
postal et un identifiant.</li>
<li>une table <code>city_postalcode</code> qui va contenir les associations entre la table
<code>cities</code> et la table <code>postalcodes</code>, avec seulement les deux colonnes
<code>cities_pk</code> et <code>postalcodes_pk</code> ("pk" pour Primary Key). La clé primaire de
cette table est constituée par ces deux colonnes.</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2019-11-11 Mon 23:28</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
